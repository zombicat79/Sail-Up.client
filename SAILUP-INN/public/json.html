<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SailUp Inn</title>
  <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="inn.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Caja para la vista previa de JSON */
    .json-preview {
      background: var(--panel-2);
      border: 1px solid var(--panel-3);
      border-radius: var(--radius);
      padding: 12px;
      max-height: 400px;     /* limita altura */
      overflow: auto;        /* scroll vertical y horizontal */
      font-family: monospace;
      font-size: 13px;
      color: var(--text-light);
      white-space: pre;      /* mantiene formato JSON */
    }
  </style>
</head>

<body>
  <!-- Header compartido -->
  <div id="header-placeholder"></div>

  <main class="chat">
    <div class="messages">

      <!-- Intro -->
      <div class="msg">
        <div class="msg-inner">
          <h1 class="q-title">üìë Json</h1>
          <p class="intro">
            En esta secci√≥n puedes convertir un archivo Excel en un <strong>JSON estructurado</strong>, 
            listo para integrarse en SailUp. Sube tu archivo y revisa la vista previa antes de descargar 
            el resultado final.
          </p>
        </div>
      </div>      

      <div class="msg">
        <div class="msg-inner">
          <h2 class="q-title">üìÇ Subir archivo Excel</h2>
          <input type="file" id="inputFile" accept=".xlsx" />
          <div class="actions">
            <button class="btn btn-primary" onclick="generateJSON()">Generar JSON</button>
            <button class="btn btn-secondary" onclick="downloadJSON()" id="downloadBtn" disabled>Descargar JSON</button>
          </div>
          <div id="error" class="error"></div>
        </div>
      </div>

      <div class="msg">
        <div class="msg-inner">
          <h2 class="q-title">üìä Vista previa JSON</h2>
          <div class="json-preview">
            <pre id="output"></pre>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Script header compartido -->
  <script src="header.js"></script>

  <script>
    let workbook;
    let generatedJSON = null;
    let jsonFileName = "output.json";

    document.getElementById("inputFile").addEventListener("change", handleFile, false);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const baseName = file.name.replace(/\.[^/.]+$/, ""); 
      jsonFileName = baseName + ".json";

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        workbook = XLSX.read(data, { type: "array" });
      };
      reader.readAsArrayBuffer(file);
    }

    function generateJSON() {
      document.getElementById("error").textContent = "";
      document.getElementById("output").textContent = "";

      if (!workbook) {
        document.getElementById("error").textContent = "‚ö†Ô∏è Por favor, sube primero un archivo Excel.";
        return;
      }

      const topicsSheet = XLSX.utils.sheet_to_json(workbook.Sheets["topics"]);
      if (!topicsSheet.length) {
        document.getElementById("error").textContent = "‚ùå No se encontr√≥ la hoja 'topics'.";
        return;
      }

      const topicsList = [];

      topicsSheet.forEach(topic => {
        const sheetName = topic.id_topic;
        const sheet = workbook.Sheets[sheetName];

        if (!sheet) {
          document.getElementById("error").textContent = `‚ùå No existe la hoja para el topic '${sheetName}'.`;
          return;
        }

        const questions = XLSX.utils.sheet_to_json(sheet);

        const items = questions.map(q => ({
          Domain: q.Domain,
          Subdomain: q.Subdomain,
          Topic: q.Topic,
          Frequency: q.Frequency,
          Thumbnail: Boolean(q.Thumbnail),
          Thumbnail_url: q.Thumbnail_url || "",
          Question: q.Question,
          Options: [
            { text: q.Option1_text, correct: true },
            { text: q.Option2_text, correct: false },
            { text: q.Option3_text, correct: false },
            { text: q.Option4_text, correct: false }
          ],
          Summary: {
            Summary1: q.Summary1,
            Summary2: q.Summary2,
            Summary3: q.Summary3,
            Summary4: q.Summary4
          }
        }));

        topicsList.push({
          id: topic.id_topic,
          title: topic.title_topic,
          description: topic.description_topic,
          image: topic.image_topic,
          items
        });
      });

      generatedJSON = { topics: { data: topicsList } };
      document.getElementById("output").textContent = JSON.stringify(generatedJSON, null, 2);
      document.getElementById("downloadBtn").disabled = false;
    }

    function downloadJSON() {
      if (!generatedJSON) {
        document.getElementById("error").textContent = "‚ö†Ô∏è Primero genera el JSON.";
        return;
      }
      const blob = new Blob([JSON.stringify(generatedJSON, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = jsonFileName;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
