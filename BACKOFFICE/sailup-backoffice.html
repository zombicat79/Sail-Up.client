<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SailUp - Excel to JSON</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    #output { white-space: pre; background: #f7f7f7; padding: 1rem; border: 1px solid #ccc; max-height: 300px; overflow-y: auto; }
    .btn { padding: 0.5rem 1rem; margin-top: 1rem; cursor: pointer; background: #007bff; color: #fff; border: none; border-radius: 5px; }
    .btn:hover { background: #0056b3; }
    .error { color: red; font-weight: bold; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>SailUp - Convertir Excel a JSON</h1>
  <input type="file" id="inputFile" accept=".xlsx" />
  <br><br>
  <button class="btn" onclick="generateJSON()">Generar JSON</button>
  <button class="btn" onclick="downloadJSON()" id="downloadBtn" disabled>Descargar JSON</button>
  
  <h2>Vista previa JSON:</h2>
  <div id="output"></div>
  <div id="error" class="error"></div>

  <script>
    let workbook;
    let generatedJSON = null;
    let jsonFileName = "output.json";

    document.getElementById("inputFile").addEventListener("change", handleFile, false);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const baseName = file.name.replace(/\.[^/.]+$/, ""); 
      jsonFileName = baseName + ".json";

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        workbook = XLSX.read(data, { type: "array" });
      };
      reader.readAsArrayBuffer(file);
    }

    function generateJSON() {
      document.getElementById("error").textContent = "";
      document.getElementById("output").textContent = "";

      if (!workbook) {
        document.getElementById("error").textContent = "⚠️ Por favor, sube primero un archivo Excel.";
        return;
      }

      // Leer hoja topics (metadatos)
      const topicsSheet = XLSX.utils.sheet_to_json(workbook.Sheets["topics"]);
      if (!topicsSheet.length) {
        document.getElementById("error").textContent = "❌ No se encontró la hoja 'topics'.";
        return;
      }

      const topicsList = [];

      topicsSheet.forEach(topic => {
        const sheetName = topic.id_topic;
        const sheet = workbook.Sheets[sheetName];

        if (!sheet) {
          document.getElementById("error").textContent = `❌ No existe la hoja para el topic '${sheetName}'.`;
          return;
        }

        const questions = XLSX.utils.sheet_to_json(sheet);

        const items = questions.map(q => ({
          Domain: q.Domain,
          Subdomain: q.Subdomain,
          Topic: q.Topic,
          Frequency: q.Frequency,
          Thumbnail: Boolean(q.Thumbnail),
          Thumbnail_url: q.Thumbnail_url || "",
          Question: q.Question,
          Options: [
            { text: q.Option1_text, correct: true },
            { text: q.Option2_text, correct: false },
            { text: q.Option3_text, correct: false },
            { text: q.Option4_text, correct: false }
          ],
          Summary: {
            Summary1: q.Summary1,
            Summary2: q.Summary2,
            Summary3: q.Summary3,
            Summary4: q.Summary4
          }
        }));

        topicsList.push({
          id: topic.id_topic,
          title: topic.title_topic,
          description: topic.description_topic,
          image: topic.image_topic,
          items
        });
      });

      generatedJSON = { topics: { data: topicsList } };

      // Mostrar en pantalla
      document.getElementById("output").textContent = JSON.stringify(generatedJSON, null, 2);

      // Habilitar botón de descarga
      document.getElementById("downloadBtn").disabled = false;
    }

    function downloadJSON() {
      if (!generatedJSON) {
        document.getElementById("error").textContent = "⚠️ Primero genera el JSON.";
        return;
      }
      const blob = new Blob([JSON.stringify(generatedJSON, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = jsonFileName;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
